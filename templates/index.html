<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ad-Free Music & Video Player</title>
    <style>
        body { font-family: Arial; background: #111; color: #fff; text-align: center; }
        video, audio { width: 80%; margin-top: 20px; }
        input { width: 60%; padding: 10px; margin-top: 20px; }
        button { padding: 10px 20px; margin-left: 10px; cursor: pointer; }
        .controls { margin-top: 10px; }
        .sidebar { float: right; width: 20%; text-align: left; background: #222; padding: 10px; max-height: 80vh; overflow-y: scroll;}
        .song-item { margin: 5px 0; cursor: pointer; }
        select { margin-left: 10px; }
    </style>
</head>
<body>
    <h1>Ad-Free Music & Video Player</h1>
    <input type="text" id="searchQuery" placeholder="Search by title, artist, year">
    <button onclick="searchSongs()">Search</button>

    <div style="display:flex;">
        <div style="flex:1;">
            <audio id="player" controls autoplay></audio>
            <div class="controls">
                <button onclick="prevSong()">Prev</button>
                <button onclick="nextSong()">Next</button>
                Volume: <input type="range" id="volume" min="0" max="1" step="0.01" onchange="setVolume(this.value)">
                Speed: <select id="speed" onchange="setSpeed(this.value)">
                    <option value="0.5">0.5x</option>
                    <option value="1" selected>1x</option>
                    <option value="1.5">1.5x</option>
                    <option value="2">2x</option>
                </select>
                Quality: <select id="quality" onchange="setQuality(this.value)"></select>
            </div>
        </div>

        <div class="sidebar" id="sidebar">
            <h3>Suggestions</h3>
        </div>
    </div>

    <script>
        let playlist = [];
        let currentIndex = 0;
        let currentQuality = "360p";

        function loadPlayer() {
            const player = document.getElementById("player");
            player.volume = 0.5;
            player.playbackRate = 1;
        }

        function searchSongs() {
            const query = document.getElementById("searchQuery").value;
            fetch(`/search?q=${encodeURIComponent(query)}`)
                .then(res => res.json())
                .then(data => {
                    playlist = data;
                    currentIndex = 0;
                    showSidebar(data);
                    playCurrent();
                });
        }

        function showSidebar(songs) {
            const sidebar = document.getElementById("sidebar");
            sidebar.innerHTML = "<h3>Suggestions</h3>";
            songs.forEach((s, i) => {
                const div = document.createElement("div");
                div.className = "song-item";
                div.textContent = `${s.title} (${s.year})`;
                div.onclick = () => { currentIndex = i; playCurrent(); };
                sidebar.appendChild(div);
            });
        }

        function playCurrent() {
            if(playlist.length === 0) return;
            const song = playlist[currentIndex];
            const player = document.getElementById("player");

            let url = song.audio_url;
            if(song.qualities.includes(currentQuality)){
                url = song.audio_url.replace(".mp3", `_${currentQuality}.mp3`);
            }

            player.src = url;
            player.play();

            // populate quality select
            const qualitySelect = document.getElementById("quality");
            qualitySelect.innerHTML = "";
            song.qualities.forEach(q => {
                const option = document.createElement("option");
                option.value = q;
                option.textContent = q;
                if(q === currentQuality) option.selected = true;
                qualitySelect.appendChild(option);
            });
        }

        function nextSong() { if(currentIndex+1 < playlist.length){ currentIndex++; playCurrent(); } }
        function prevSong() { if(currentIndex-1 >=0){ currentIndex--; playCurrent(); } }
        function setVolume(v){ document.getElementById("player").volume = v; }
        function setSpeed(s){ document.getElementById("player").playbackRate = s; }
        function setQuality(q){ currentQuality = q; playCurrent(); }

        loadPlayer();
    </script>
</body>
</html>
