<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ad-Free Music Player</title>
  <style>
    body{margin:0;font-family:sans-serif;background:#111;color:#eee;display:flex;flex-direction:column;height:100vh}
    header{background:#222;padding:8px;text-align:center}
    #q{width:60%;padding:8px;border-radius:6px;border:none}
    main{flex:1;display:flex;overflow:hidden}
    video{width:100%;border-radius:8px;background:#000;max-height:360px}
    .player{flex:3;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:10px}
    .controls{margin-top:10px;display:flex;gap:10px;align-items:center}
    .sidebar{flex:1;width:320px;max-height:60vh;overflow:auto;padding:8px;background:rgba(10,12,13,0.6);border-radius:12px}
    .song{padding:6px;cursor:pointer;display:flex;gap:8px;border-bottom:1px solid #333}
    .song:hover{background:#333}
    .song img{width:60px;height:60px;object-fit:cover;border-radius:4px}
    .active{background:#444 !important}
  </style>
</head>
<body>
  <header>
    <input id="q" type="text" placeholder="Search..." 
           onkeypress="if(event.key==='Enter'){doSearch();}" />
    <button onclick="doSearch()">Search</button>
  </header>
  <main>
    <div class="player">
      <video id="player" controls autoplay></video>
      <div class="controls">
        <button onclick="prev()">⏮️</button>
        <button onclick="playPause()">⏯️</button>
        <button onclick="next()">⏭️</button>
        <label>Quality:
          <select id="qualitySelect" onchange="changeQuality()"></select>
        </label>
      </div>
      <div id="nowInfo"></div>
    </div>
    <div class="sidebar" id="sidebar"></div>
  </main>
  <script>
    let playlist=[], currentIndex=0;
    const player=document.getElementById("player");
    const sidebar=document.getElementById("sidebar");
    const qualitySelect=document.getElementById("qualitySelect");
    const nowInfo=document.getElementById("nowInfo");

    async function doSearch(){
      const q=document.getElementById("q").value;
      const res=await fetch(`/search?q=${encodeURIComponent(q)}`);
      const data=await res.json();
      playlist=data.results;
      sidebar.innerHTML="";
      playlist.forEach((s,i)=>{
        const div=document.createElement("div");
        div.className="song";
        div.onclick=()=>playAt(i);
        div.innerHTML=`<img src="${s.thumbnail}"/><div><b>${s.title}</b><br>${s.artist} (${s.year})</div>`;
        sidebar.appendChild(div);
      });
      if(playlist.length) playAt(0);
    }

    function playAt(i){
      if(i<0 || i>=playlist.length) return;
      currentIndex=i;
      const item=playlist[i];
      highlightActive();
      nowInfo.innerText=`${item.title} — ${item.artist} (${item.year})`;
      qualitySelect.innerHTML="";
      if(item.qualities && item.qualities.length){
        item.qualities.forEach(q=>{
          const o=document.createElement('option');
          o.value=q; o.textContent=q;
          qualitySelect.appendChild(o);
        });
      }
      setSourceForQuality(item, qualitySelect.value || null);
    }

    function setSourceForQuality(item, quality){
      let url="";
      if(quality && item.sources && item.sources[quality]){
        url=item.sources[quality];
      } else {
        url=item.video_url || item.audio_url;
      }
      if(!url){alert("No playable source");return;}
      player.src=url;
      player.load();
      player.play();
    }

    function changeQuality(){
      const item=playlist[currentIndex];
      setSourceForQuality(item, qualitySelect.value);
    }

    function playPause(){player.paused?player.play():player.pause();}
    function next(){if(currentIndex<playlist.length-1)playAt(currentIndex+1);}
    function prev(){if(currentIndex>0)playAt(currentIndex-1);}

    function highlightActive(){
      [...sidebar.children].forEach((c,idx)=>c.classList.toggle("active",idx===currentIndex));
    }
  </script>
</body>
</html>
