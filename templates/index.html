<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Ad-Free Music & Video Player</title>
<style>
body { font-family: Arial, sans-serif; background: #111; color: #fff; margin:0; }
header { background:#222; padding:10px; text-align:center; }
h1 { margin:0; color:#f5f5f5; }
input { width: 50%; padding: 10px; margin-top: 10px; }
button { padding: 10px 20px; margin-left: 5px; cursor: pointer; }
main { display:flex; }
.player-container { flex:1; padding:20px; text-align:center; }
.media-box { width:80%; height:280px; background:#000; margin:0 auto; display:flex; align-items:center; justify-content:center; }
audio, video { max-width:100%; max-height:100%; }
.controls { margin-top: 15px; }
.sidebar { width:300px; background:#181818; padding:10px; overflow-y:auto; height:calc(100vh - 60px); }
.song-item { margin:8px 0; cursor: pointer; display:flex; align-items:center; background:#222; padding:5px; border-radius:6px; }
.song-item.active { background:#444; }
.song-item img { width:50px; height:50px; margin-right:10px; object-fit:cover; border-radius:4px; }
select, input[type=range] { margin-left: 8px; }
</style>
</head>
<body>
<header>
  <h1>Ad-Free Music & Video Player</h1>
  <input type="text" id="searchQuery" placeholder="Search song, artist, movie, year">
  <button onclick="searchSongs()">Search</button>
</header>

<main>
  <div class="player-container">
    <div class="media-box" id="mediaBox"></div>

    <div class="controls">
      <button onclick="prevSong()">⏮ Prev</button>
      <button onclick="nextSong()">⏭ Next</button>
      Volume: <input type="range" id="volume" min="0" max="1" step="0.01" onchange="setVolume(this.value)">
      Speed: <select id="speed" onchange="setSpeed(this.value)">
        <option value="0.5">0.5x</option>
        <option value="1" selected>1x</option>
        <option value="1.5">1.5x</option>
        <option value="2">2x</option>
      </select>
      Quality: <select id="quality" onchange="setQuality(this.value)"></select>
    </div>
  </div>

  <div class="sidebar" id="sidebar">
    <h3>Suggestions</h3>
  </div>
</main>

<script>
let playlist = [];
let currentIndex = 0;
let currentQuality = "";

function loadDefaultSongs() {
  fetch('/default_songs').then(res => res.json()).then(data => {
    playlist = data; currentIndex=0; showSidebar(data); playCurrent();
  });
}

function searchSongs() {
  const query = document.getElementById("searchQuery").value;
  fetch(`/search?q=${encodeURIComponent(query)}`).then(res=>res.json()).then(data=>{
    playlist=data; currentIndex=0; showSidebar(data); playCurrent();
  });
}

// Enter key trigger for search
document.getElementById("searchQuery").addEventListener("keypress", function(e){
  if(e.key==="Enter"){ searchSongs(); }
});

function showSidebar(songs) {
  const sidebar = document.getElementById("sidebar");
  sidebar.innerHTML = "<h3>Suggestions</h3>";
  songs.forEach((s,i)=>{
    const div = document.createElement("div"); 
    div.className="song-item"+(i===currentIndex?" active":"");
    div.innerHTML=`<img src="${s.thumbnail}" onerror="this.src='https://via.placeholder.com/50'"/> 
      <div>${s.title} (${s.year})<br><small>${s.artist}</small></div>`;
    div.onclick=()=>{currentIndex=i; playCurrent();};
    sidebar.appendChild(div);
  });
}

function playCurrent() {
  if(playlist.length===0) return;
  const song = playlist[currentIndex];
  const mediaBox = document.getElementById("mediaBox");
  mediaBox.innerHTML="";

  let player;
  if(song.audio_url){
    player = document.createElement("audio");
    player.controls=true; player.autoplay=true;
    player.src = song.audio_url;
  } else if(song.video_url){
    player = document.createElement("video");
    player.controls=true; player.autoplay=true;
    player.src = song.video_url;
  }
  player.id="player";
  mediaBox.appendChild(player);
  player.play();

  // populate quality
  const qualitySelect = document.getElementById("quality");
  qualitySelect.innerHTML="";
  song.qualities.forEach(q=>{
    const option=document.createElement("option");
    option.value=q; option.textContent=q;
    qualitySelect.appendChild(option);
  });
  currentQuality = song.qualities[0];
  qualitySelect.value=currentQuality;

  showSidebar(playlist); // refresh highlight
}

function nextSong(){ if(currentIndex+1<playlist.length){currentIndex++; playCurrent();} }
function prevSong(){ if(currentIndex-1>=0){currentIndex--; playCurrent();} }
function setVolume(v){ document.getElementById("player").volume=v; }
function setSpeed(s){ document.getElementById("player").playbackRate=s; }
function setQuality(q){ currentQuality=q; playCurrent(); }

loadDefaultSongs();
</script>
</body>
</html>
