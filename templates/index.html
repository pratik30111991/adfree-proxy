<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>YouTube Player Proxy</title>
<style>
  body { font-family: Arial; text-align: center; padding: 20px; }
  video, iframe { width: 100%; max-width: 720px; margin-top: 20px; }
  button { margin: 5px; padding: 10px 20px; }
  select { margin: 5px; padding: 5px; }
</style>
</head>
<body>

<h1>YouTube Player Proxy</h1>
<input type="text" id="yturl" placeholder="Paste YouTube URL here" size="80">
<button onclick="loadVideo()">Load</button>

<div id="playerContainer" style="display:none;">
    <h2 id="title"></h2>
    <video id="videoPlayer" controls></video><br>
    <button onclick="prevVideo()">Previous</button>
    <button onclick="nextVideo()">Next</button><br>
    Quality: 
    <select id="qualitySelect" onchange="changeQuality()"></select>
</div>

<script>
let playlist = [];
let currentIndex = 0;
let currentFormats = [];

async function loadVideo() {
    const url = document.getElementById("yturl").value;
    if (!url) return alert("Please paste a YouTube URL");
    
    const res = await fetch("/get_video", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ url })
    });
    const data = await res.json();
    if (data.error) return alert(data.error);

    playlist = [data.current].concat(data.next_videos);
    currentIndex = 0;
    currentFormats = playlist[0].formats || [];
    showVideo(currentIndex);
}

function showVideo(index) {
    if (!playlist[index]) return;
    const v = playlist[index];
    document.getElementById("playerContainer").style.display = "block";
    document.getElementById("title").innerText = v.title;

    const videoEl = document.getElementById("videoPlayer");

    if (v.formats && v.formats.length > 0) {
        currentFormats = v.formats;
        videoEl.src = `https://www.youtube.com/watch?v=${v.id}`;
        populateQualitySelect(currentFormats);
    } else {
        videoEl.src = `https://www.youtube.com/watch?v=${v.id}`;
        document.getElementById("qualitySelect").innerHTML = "";
    }

    videoEl.play().catch(e => console.log(e));
    console.log(`Playing: ${v.title}`);
}

function nextVideo() {
    if (currentIndex + 1 < playlist.length) {
        currentIndex++;
        showVideo(currentIndex);
    }
}

function prevVideo() {
    if (currentIndex - 1 >= 0) {
        currentIndex--;
        showVideo(currentIndex);
    }
}

function populateQualitySelect(formats) {
    const select = document.getElementById("qualitySelect");
    select.innerHTML = "";
    formats.forEach(f => {
        const opt = document.createElement("option");
        opt.value = f.format_id;
        opt.innerText = `${f.resolution} (${f.ext})`;
        select.appendChild(opt);
    });
}

function changeQuality() {
    const selected = document.getElementById("qualitySelect").value;
    const fmt = currentFormats.find(f => f.format_id === selected);
    const videoEl = document.getElementById("videoPlayer");
    if (fmt) {
        videoEl.src = `https://www.youtube.com/watch?v=${playlist[currentIndex].id}`;
        videoEl.play();
        console.log(`Quality changed to: ${fmt.resolution} (${fmt.ext})`);
    }
}
</script>

</body>
</html>
