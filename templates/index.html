<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>YouTube Ad-Free Player</title>
<style>
body{font-family:Arial,Helvetica,sans-serif;margin:20px;}
input[type=text]{width:70%;padding:8px;}
button{padding:6px 12px;margin:4px;}
#player{margin-top:20px;}
.controls{margin-top:10px;}
#qualitySelect{margin-left:8px;}
</style>
</head>
<body>
<h2>YouTube Ad-Free Player (No Ads)</h2>

<form onsubmit="loadVideo(); return false;">
  <label>Enter YouTube URL or Playlist URL:</label><br>
  <input type="text" id="yturl" placeholder="https://youtu.be/abc123" required>
  <button type="submit">Load</button>
  <button type="button" onclick="document.getElementById('yturl').value=''">Clear</button>
</form>

<div class="controls">
  <button onclick="prevVideo()">⏮ Prev</button>
  <button onclick="nextVideo()">⏭ Next</button>
  <label>Quality:</label>
  <select id="qualitySelect" onchange="changeQuality()"></select>
</div>

<div id="player"></div>
<div id="info" style="margin-top:10px;color:#555;"></div>

<script>
let videoList = [];
let currentIndex = 0;
let currentFormats = [];
let currentVideoId = "";

async function loadVideo() {
  let url = document.getElementById('yturl').value.trim();
  if(!url) return;

  const res = await fetch("/get_video", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({url})
  });
  const data = await res.json();
  if(data.error){ alert(data.error); return; }

  if(data.next_videos && data.next_videos.length>0){
    videoList = data.next_videos.map(v=>v.url)
  } else {
    videoList = [url];
  }
  currentIndex = 0;
  playCurrentVideo(data);
}

async function playCurrentVideo(data=null){
  let url = videoList[currentIndex];
  if(!data){
    const res = await fetch("/get_video", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({url})
    });
    data = await res.json();
    if(data.error){ alert(data.error); return; }
  }

  currentVideoId = data.id;
  currentFormats = data.formats || [];
  const qualitySelect = document.getElementById('qualitySelect');
  qualitySelect.innerHTML = "";
  currentFormats.forEach(f=>{
    let opt = document.createElement("option");
    opt.value = f.format_id;
    opt.text = f.resolution+" ("+f.filesize+"MB)";
    qualitySelect.appendChild(opt);
  });

  let fmt = currentFormats[0];
  loadIframe(currentVideoId, fmt.format_id);

  logPlay(data.title, fmt);
}

function loadIframe(videoId, format_id){
  document.getElementById('player').innerHTML =
    `<iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/${videoId}?autoplay=1&modestbranding=1&rel=0" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
  document.getElementById('info').innerText = "Playing video ID: "+videoId+" | format: "+format_id;
}

function nextVideo(){
  if(videoList.length==0) return;
  currentIndex = (currentIndex+1)%videoList.length;
  playCurrentVideo();
}

function prevVideo(){
  if(videoList.length==0) return;
  currentIndex = (currentIndex-1+videoList.length)%videoList.length;
  playCurrentVideo();
}

function changeQuality(){
  let select = document.getElementById('qualitySelect');
  let selectedId = select.value;
  let fmt = currentFormats.find(f=>f.format_id==selectedId);
  if(fmt) loadIframe(currentVideoId, fmt.format_id);
}

function logPlay(title, fmt){
  fetch("/log_play", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({
      video_id: currentVideoId,
      title: title,
      quality: fmt.resolution,
      size_mb: fmt.filesize,
      action: "PLAY"
    })
  });
}
</script>
</body>
</html>
